<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mes Jeux ‚Äî Gestion & Consultation</title>
  <style>
    :root{
      --bg: #f7f7f8;
      --card:#ffffff;
      --text:#111113;
      --muted:#666;
      --accent:#7c3aed;
      --accent-2:#22c55e;
      --border:#e5e7eb;
    }
    [data-theme="dark"]{
      --bg:#0b0b0c;
      --card:#121214;
      --text:#f5f5f6;
      --muted:#b3b3b6;
      --accent:#a78bfa;
      --accent-2:#34d399;
      --border:#2a2a2e;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:var(--bg); border-bottom:1px solid var(--border);
      display:flex; gap:.75rem; align-items:center; padding:.75rem 1rem; flex-wrap:wrap;
    }
    header h1{font-size:1.15rem; margin:0; letter-spacing:.2px}
    .spacer{flex:1}
    .pill{
      border:1px solid var(--border); background:var(--card); border-radius:999px;
      padding:.35rem .75rem; font-size:.9rem; display:inline-flex; align-items:center; gap:.5rem;
    }
    .tabs{ display:flex; gap:.5rem; flex-wrap:wrap }
    .tab-btn{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      padding:.5rem .8rem; border-radius:10px; font-weight:600; cursor:pointer;
    }
    .tab-btn.active{ border-color:var(--accent); outline:2px solid color-mix(in oklab, var(--accent) 35%, transparent); }
    main{ padding:1rem; max-width:1200px; margin:0 auto }
    section{ display:none }
    section.active{ display:block }

    /* Create/Edit layout */
    .grid{
      display:grid; gap:1rem;
      grid-template-columns: repeat(12, minmax(0,1fr));
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1rem;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{ margin:.25rem 0 1rem 0; font-size:1rem }
    .col-4{ grid-column: span 4 }
    .col-6{ grid-column: span 6 }
    .col-8{ grid-column: span 8 }
    .col-12{ grid-column: span 12 }
    @media (max-width: 900px){
      .col-4,.col-6,.col-8{ grid-column: span 12 }
    }
    label{ display:block; font-size:.85rem; margin:.35rem 0 .25rem; color:var(--muted) }
    input[type="text"],
    input[type="number"],
    input[type="url"],
    textarea, select{
      width:100%; padding:.6rem .7rem; border-radius:10px;
      border:1px solid var(--border); background:var(--bg); color:var(--text);
      outline:none;
    }
    textarea{ min-height:96px; resize:vertical }
    .row{ display:flex; gap:.5rem; align-items:center }
    .row > *{ flex:1 }
    .chiplist{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.35rem }
    .chip{
      padding:.25rem .5rem; border-radius:999px; border:1px dashed var(--border);
      font-size:.8rem; cursor:default; background:var(--bg)
    }
    .btn{
      background:var(--card); color:var(--text); border:1px solid var(--border);
      padding:.6rem .8rem; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn.primary{ background:var(--accent); color:white; border-color: transparent }
    .btn.green{ background:var(--accent-2); color:black; border-color: transparent }
    .btn.danger{ background:#ef4444; color:white; border-color:transparent }
    .btn-row{ display:flex; gap:.5rem; flex-wrap:wrap }
    .muted{ color:var(--muted); font-size:.9rem }

    /* Table / Cards for consult */
    .toolbar{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:1rem }
    .toolbar input,.toolbar select{ background:var(--card) }
    .cards{
      display:grid; gap:.75rem;
      grid-template-columns: repeat( auto-fit, minmax(260px,1fr) );
    }
    .game{
      border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--card);
      display:flex; flex-direction:column; min-height:160px;
    }
    .game header{
      border:0; padding:.6rem .8rem; display:flex; gap:.5rem; align-items:center;
    }
    .game img{
      width:100%; height:160px; object-fit:cover; display:block; background:#0003
    }
    .game .meta{ padding:.75rem; display:flex; flex-wrap:wrap; gap:.25rem .5rem; font-size:.9rem; color:var(--muted) }
    .game .desc{ padding:.75rem; padding-top:0; font-size:.95rem }
    .badge{ padding:.1rem .45rem; border-radius:6px; background:color-mix(in oklab, var(--accent) 25%, transparent);
      border:1px solid var(--border); font-size:.75rem; color:var(--text) }
    .tiny{ font-size:.82rem; color:var(--muted) }
    .right{ margin-left:auto }
    .hidden{ display:none !important }

    /* Print */
    @media print{
      header, .toolbar, .tab-btn, .btn { display:none !important }
      body{ background:white }
      .cards{ grid-template-columns: repeat(2, 1fr) }
    }
  </style>
</head>
<body>
  <header>
    <h1>üé≤ Mes Jeux</h1>
    <div class="spacer"></div>
    <div class="pill">
      <span id="storageIndicator">Stockage¬†: Local</span>
      <select id="storageSelect" title="Choisir le stockage">
        <option value="local">Local</option>
        <option value="cloud">Cloud (Blob)</option>
      </select>
    </div>
    <button id="themeToggle" class="btn">Th√®me</button>
    <nav class="tabs">
      <button class="tab-btn" data-tab="consult">Consulter / Imprimer</button>
      <button class="tab-btn" data-tab="edit">Cr√©er / √âditer</button>
    </nav>
  </header>

  <main>
    <!-- CONSULT TAB -->
    <section id="consult" class="active">
      <div class="toolbar card">
        <input id="q" type="text" placeholder="Rechercher (nom, type, remarque, description)..." />
        <input id="fltPlayersMin" type="number" min="1" placeholder="Joueurs min" />
        <input id="fltPlayersMax" type="number" min="1" placeholder="Joueurs max" />
        <input id="fltAge" type="number" min="0" placeholder="√Çge max (ex: 8+ ‚Üí 8)" />
        <input id="fltDurMin" type="number" min="0" placeholder="Dur√©e min (min)" />
        <input id="fltDurMax" type="number" min="0" placeholder="Dur√©e max (min)" />
        <select id="fltTypes" multiple size="1" title="Filtrer par types (Ctrl/Cmd pour multi)"></select>
        <button class="btn" id="btnPrint">Imprimer</button>
        <span class="spacer"></span>
        <span class="tiny" id="countInfo"></span>
      </div>
      <div class="cards" id="cards"></div>
    </section>

    <!-- EDIT TAB -->
    <section id="edit">
      <div class="grid">
        <div class="card col-4">
          <h2>Param√®tres</h2>
          <label>Types (s√©par√©s par des virgules)</label>
          <input id="paramTypes" type="text" placeholder="Ambiance, Cartes, Coop√©ratif, ..." />
          <div class="muted">Ces types alimentent les s√©lections et filtres.</div>
          <hr style="border:none;border-top:1px solid var(--border); margin:1rem 0;">
          <div class="btn-row">
            <button class="btn" id="btnSaveParams">Enregistrer param√®tres</button>
            <button class="btn" id="btnResetParams">Types par d√©faut</button>
          </div>
        </div>

        <div class="card col-8">
          <h2>Gestion des jeux</h2>
          <div class="row">
            <div>
              <label>Nom</label>
              <input id="gName" type="text" />
            </div>
            <div>
              <label>Nb joueurs min</label>
              <input id="gPmin" type="number" min="1" />
            </div>
            <div>
              <label>Nb joueurs max</label>
              <input id="gPmax" type="number" min="1" />
            </div>
            <div>
              <label>√Çge conseill√© (ex: 8 pour 8+)</label>
              <input id="gAge" type="number" min="0" />
            </div>
            <div>
              <label>Dur√©e (min)</label>
              <input id="gDur" type="number" min="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Type(s) ‚Äî Maintenir Ctrl/Cmd pour multi</label>
              <select id="gTypes" multiple size="4"></select>
              <div class="chiplist" id="gTypesPreview"></div>
            </div>
            <div>
              <label>Remarques</label>
              <input id="gNotes" type="text" />
              <label>Lien (Gilles Digitale)</label>
              <input id="gUrl" type="url" placeholder="https://..." />
            </div>
            <div>
              <label>Photo (upload)</label>
              <input id="gPhoto" type="file" accept="image/*" />
              <img id="gPreview" alt="" style="margin-top:.5rem; max-width:100%; border-radius:12px; border:1px solid var(--border)">
            </div>
          </div>
          <label>Description</label>
          <textarea id="gDesc"></textarea>

          <div class="btn-row" style="margin-top:.75rem">
            <button class="btn primary" id="btnAdd">Ajouter / Mettre √† jour</button>
            <button class="btn danger" id="btnDelete">Supprimer</button>
            <span class="spacer"></span>
            <select id="selectGame"></select>
            <button class="btn" id="btnLoad">Charger</button>
            <button class="btn" id="btnClearForm">Vider le formulaire</button>
          </div>
        </div>

        <div class="card col-12">
          <h2>Importer / Exporter / Cloud</h2>
          <div class="btn-row">
            <button class="btn" id="btnExport">Exporter JSON</button>
            <input type="file" id="importFile" accept="application/json" />
            <button class="btn" id="btnImport">Importer</button>
            <span class="spacer"></span>
            <input id="datasetKey" type="text" placeholder="Nom de dataset (ex: mes-jeux)" style="max-width:220px">
            <button class="btn green" id="btnCloudPush">Pousser vers Cloud</button>
            <button class="btn" id="btnCloudPull">Charger depuis Cloud</button>
          </div>
          <div class="tiny" style="margin-top:.5rem">
            <strong>Astuce Cloud (Blob)</strong>¬†: configurez vos endpoints dans <code>CONFIG.cloud.*</code> ci‚Äëdessous (m√™mes principes que votre app Planning). Le token est envoy√© dans l‚Äôen‚Äët√™te Authorization.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
  // ---- Storage adapter (Local or Cloud Blob) ----
  const CONFIG = {
    backend: localStorage.getItem("jeux.backend") || "local", // "local" | "cloud"
    cloud: {
      listUrl: "/api/games/list",   // GET ‚Üí { keys: [] }
      getUrl: "/api/games/get",     // GET ?key=xxx ‚Üí { key, data }
      putUrl: "/api/games/put",     // PUT body: { key, data }
      deleteUrl: "/api/games/delete", // DELETE ?key=xxx
      token: "" // facultatif
    },
    defaults: {
      types: "Ambiance, Cartes, Bluff, Coop√©ratif, Deckbuilding, D√©duction, D√©s, D√©veloppement, Enqu√™te, Escape Game, Gestion, Pose de tuiles, Quiz, Strat√©gie, Abstrait, Parcours, Commerce, M√©moire, Connaissances, Classiques"
    }
  };

  const ls = {
    get key(){ return "jeux.dataset" },
    save(dataset){
      localStorage.setItem(this.key, JSON.stringify(dataset));
    },
    load(){
      try{ return JSON.parse(localStorage.getItem(this.key) || '{"params":{},"items":[]}' ); }
      catch{ return { params:{}, items:[] } }
    }
  };

  const cloud = {
    async list(){
      const r = await fetch(CONFIG.cloud.listUrl, { headers: authHeaders() });
      if(!r.ok) throw new Error("Cloud list a √©chou√©");
      return r.json();
    },
    async get(key){
      const r = await fetch(CONFIG.cloud.getUrl + "?key=" + encodeURIComponent(key), { headers: authHeaders() });
      if(!r.ok) throw new Error("Cloud get a √©chou√©");
      return r.json();
    },
    async put(key, data){
      const r = await fetch(CONFIG.cloud.putUrl, {
        method:"PUT",
        headers: { "Content-Type":"application/json", ...authHeaders() },
        body: JSON.stringify({ key, data })
      });
      if(!r.ok) throw new Error("Cloud put a √©chou√©");
      return r.json();
    },
    async delete(key){
      const r = await fetch(CONFIG.cloud.deleteUrl + "?key=" + encodeURIComponent(key), {
        method:"DELETE",
        headers: authHeaders()
      });
      if(!r.ok) throw new Error("Cloud delete a √©chou√©");
      return r.json();
    }
  };

  function authHeaders(){
    return CONFIG.cloud.token ? { "Authorization": "Bearer " + CONFIG.cloud.token } : {};
  }

  // ---- Theme ----
  const storedTheme = localStorage.getItem("jeux.theme");
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute("data-theme", storedTheme || (prefersDark ? "dark" : "light"));

  document.getElementById("themeToggle").addEventListener("click", ()=>{
    const current = document.documentElement.getAttribute("data-theme");
    const next = current === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("jeux.theme", next);
  });

  // ---- Tabs ----
  const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
  const sections = {
    consult: document.getElementById("consult"),
    edit: document.getElementById("edit")
  };
  function activateTab(id){
    for(const b of tabButtons){ b.classList.toggle("active", b.dataset.tab===id); }
    for(const k in sections){ sections[k].classList.toggle("active", k===id); }
    localStorage.setItem("jeux.startTab", id);
  }
  tabButtons.forEach(b => b.addEventListener("click", ()=> activateTab(b.dataset.tab)));

  // start on Consulter
  activateTab(localStorage.getItem("jeux.startTab") || "consult");

  // ---- Storage selector ----
  const storageSelect = document.getElementById("storageSelect");
  const storageIndicator = document.getElementById("storageIndicator");
  storageSelect.value = CONFIG.backend;
  storageIndicator.textContent = "Stockage : " + (CONFIG.backend==="cloud" ? "Cloud" : "Local");
  storageSelect.addEventListener("change", (e)=>{
    CONFIG.backend = e.target.value;
    localStorage.setItem("jeux.backend", CONFIG.backend);
    storageIndicator.textContent = "Stockage : " + (CONFIG.backend==="cloud" ? "Cloud" : "Local");
  });

  // ---- Dataset in-memory ----
  let DATA = ls.load(); // { params:{ types }, items:[game] }
  if(!DATA.params) DATA.params = {};
  if(!Array.isArray(DATA.items)) DATA.items = [];

  // ---- Params (types) ----
  const paramTypes = document.getElementById("paramTypes");
  const btnSaveParams = document.getElementById("btnSaveParams");
  const btnResetParams = document.getElementById("btnResetParams");
  const gTypes = document.getElementById("gTypes");
  const fltTypes = document.getElementById("fltTypes");

  function setDefaultTypes(){
    paramTypes.value = CONFIG.defaults.types;
  }
  function syncTypesToSelects(){
    const types = paramTypes.value.split(",").map(t=>t.trim()).filter(Boolean);
    const selects = [gTypes, fltTypes];
    for(const sel of selects){
      const current = Array.from(sel.selectedOptions).map(o=>o.value);
      sel.innerHTML = "";
      types.forEach(t=>{
        const o = document.createElement("option");
        o.value = t; o.textContent = t;
        if(current.includes(t)) o.selected = true;
        sel.appendChild(o);
      });
    }
  }
  btnSaveParams.addEventListener("click", ()=>{
    DATA.params.types = paramTypes.value;
    ls.save(DATA);
    syncTypesToSelects();
    render();
  });
  btnResetParams.addEventListener("click", ()=>{
    setDefaultTypes();
    DATA.params.types = paramTypes.value;
    ls.save(DATA);
    syncTypesToSelects();
  });

  // Init params
  if(!DATA.params.types){ setDefaultTypes(); DATA.params.types = paramTypes.value; ls.save(DATA); }
  else { paramTypes.value = DATA.params.types; }
  syncTypesToSelects();

  // ---- Form refs ----
  const fields = {
    name: document.getElementById("gName"),
    pmin: document.getElementById("gPmin"),
    pmax: document.getElementById("gPmax"),
    age: document.getElementById("gAge"),
    dur: document.getElementById("gDur"),
    notes: document.getElementById("gNotes"),
    url: document.getElementById("gUrl"),
    desc: document.getElementById("gDesc"),
    types: gTypes,
    photo: document.getElementById("gPhoto"),
    preview: document.getElementById("gPreview")
  };

  const selectGame = document.getElementById("selectGame");
  const btnAdd = document.getElementById("btnAdd");
  const btnDelete = document.getElementById("btnDelete");
  const btnLoad = document.getElementById("btnLoad");
  const btnClearForm = document.getElementById("btnClearForm");

  function clearForm(){
    for(const k of ["name","pmin","pmax","age","dur","notes","url","desc"]){ fields[k].value = ""; }
    fields.types.selectedIndex = -1;
    fields.photo.value = "";
    fields.preview.src = "";
    document.getElementById("gTypesPreview").innerHTML = "";
    selectGame.value = "";
  }
  document.getElementById("btnClearForm").addEventListener("click", clearForm);

  fields.types.addEventListener("change", ()=>{
    const chips = Array.from(fields.types.selectedOptions).map(o => `<span class="chip">${o.value}</span>`).join("");
    document.getElementById("gTypesPreview").innerHTML = chips;
  });

  fields.photo.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f){ fields.preview.src=""; return; }
    const b64 = await fileToDataUrl(f);
    fields.preview.src = b64;
    fields.preview.dataset.b64 = b64;
  });

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const rdr = new FileReader();
      rdr.onload = () => resolve(rdr.result);
      rdr.onerror = reject;
      rdr.readAsDataURL(file);
    });
  }

  function refreshSelect(){
    selectGame.innerHTML = `<option value="">‚Äî S√©lectionner un jeu ‚Äî</option>`
      + DATA.items.map((g,i)=> `<option value="${i}">${g.name}</option>`).join("");
  }
  function loadToForm(index){
    const g = DATA.items[index];
    if(!g) return;
    fields.name.value = g.name || "";
    fields.pmin.value = g.pmin ?? "";
    fields.pmax.value = g.pmax ?? "";
    fields.age.value = g.age ?? "";
    fields.dur.value = g.dur ?? "";
    fields.notes.value = g.notes || "";
    fields.url.value = g.url || "";
    fields.desc.value = g.desc || "";
    // types
    const ts = new Set(g.types || []);
    for(const o of fields.types.options){ o.selected = ts.has(o.value); }
    fields.types.dispatchEvent(new Event("change"));
    // photo
    fields.preview.src = g.photo || "";
    fields.preview.dataset.b64 = g.photo || "";
  }

  btnLoad.addEventListener("click", ()=>{
    const i = parseInt(selectGame.value, 10);
    if(Number.isInteger(i)){ loadToForm(i); }
  });

  btnAdd.addEventListener("click", ()=>{
    const name = fields.name.value.trim();
    if(!name){ alert("Nom requis"); return; }
    const obj = {
      name,
      pmin: parseInt(fields.pmin.value||"0",10)||0,
      pmax: parseInt(fields.pmax.value||"0",10)||0,
      age:  parseInt(fields.age.value||"0",10)||0,
      dur:  parseInt(fields.dur.value||"0",10)||0,
      types: Array.from(fields.types.selectedOptions).map(o=>o.value),
      notes: fields.notes.value.trim(),
      url: fields.url.value.trim(),
      desc: fields.desc.value.trim(),
      photo: fields.preview.dataset.b64 || ""
    };
    // upsert by name
    const idx = DATA.items.findIndex(g => g.name.toLowerCase() === name.toLowerCase());
    if(idx>=0) DATA.items[idx] = obj; else DATA.items.push(obj);
    ls.save(DATA);
    refreshSelect(); render();
  });

  btnDelete.addEventListener("click", ()=>{
    const name = fields.name.value.trim();
    if(!name){ alert("S√©lectionnez un jeu √† supprimer (ou chargez-le)"); return; }
    const idx = DATA.items.findIndex(g => g.name.toLowerCase() === name.toLowerCase());
    if(idx>=0){
      if(confirm("Supprimer ce jeu ?")){ DATA.items.splice(idx,1); ls.save(DATA); refreshSelect(); clearForm(); render(); }
    } else {
      alert("Jeu non trouv√©.");
    }
  });

  // ---- Import/Export/Cloud ----
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const importFile = document.getElementById("importFile");
  const btnCloudPush = document.getElementById("btnCloudPush");
  const btnCloudPull = document.getElementById("btnCloudPull");
  const datasetKey = document.getElementById("datasetKey");

  btnExport.addEventListener("click", ()=>{
    const blob = new Blob([ JSON.stringify(DATA, null, 2) ], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = (datasetKey.value || "mes-jeux") + ".json";
    a.click();
    URL.revokeObjectURL(url);
  });

  btnImport.addEventListener("click", async ()=>{
    const f = importFile.files?.[0];
    if(!f){ alert("Choisir un fichier JSON"); return; }
    const txt = await f.text();
    try{
      const incoming = JSON.parse(txt);
      if(!incoming.items) throw new Error("Format invalide");
      DATA = incoming;
      ls.save(DATA);
      // mirror params field if needed
      if(!DATA.params) DATA.params = {};
      if(!DATA.params.types && typeof DATA.params.types !== "string"){
        if(paramTypes.value) DATA.params.types = paramTypes.value;
      }
      // refresh
      if(DATA.params.types){ paramTypes.value = DATA.params.types; }
      syncTypesToSelects();
      refreshSelect(); render();
      alert("Import OK");
    }catch(e){ alert("Erreur d'import: " + e.message); }
  });

  btnCloudPush.addEventListener("click", async ()=>{
    const key = (datasetKey.value || "mes-jeux").trim();
    if(!key){ alert("Indiquez un nom de dataset"); return; }
    try{
      await cloud.put(key, DATA);
      alert("Pouss√© vers le Cloud ‚úî");
    }catch(e){ alert("Cloud (put) : " + e.message); }
  });
  btnCloudPull.addEventListener("click", async ()=>{
    const key = (datasetKey.value || "mes-jeux").trim();
    if(!key){ alert("Indiquez un nom de dataset"); return; }
    try{
      const res = await cloud.get(key); // {key,data}
      if(res && res.data){
        DATA = res.data;
        ls.save(DATA);
        if(DATA.params?.types){ paramTypes.value = DATA.params.types; }
        syncTypesToSelects();
        refreshSelect(); render();
        alert("Charg√© depuis le Cloud ‚úî");
      } else {
        alert("Aucune donn√©e pour cette cl√©.");
      }
    }catch(e){ alert("Cloud (get) : " + e.message); }
  });

  // ---- Consult rendering & filters ----
  const cards = document.getElementById("cards");
  const q = document.getElementById("q");
  const fltPlayersMin = document.getElementById("fltPlayersMin");
  const fltPlayersMax = document.getElementById("fltPlayersMax");
  const fltAge = document.getElementById("fltAge");
  const fltDurMin = document.getElementById("fltDurMin");
  const fltDurMax = document.getElementById("fltDurMax");
  const countInfo = document.getElementById("countInfo");
  document.getElementById("btnPrint").addEventListener("click", ()=> window.print());

  function matchesFilters(g){
    const qq = q.value.trim().toLowerCase();
    if(qq){
      const hay = [g.name, g.notes, g.desc, (g.types||[]).join(" ")].join(" ").toLowerCase();
      if(!hay.includes(qq)) return false;
    }
    const pmin = parseInt(fltPlayersMin.value||"0",10)||0;
    const pmax = parseInt(fltPlayersMax.value||"0",10)||0;
    if(pmin || pmax){
      // overlap logic: game range [gpmin,gpmax] must intersect [pmin,pmax] (or single if only min or max)
      const gpmin = g.pmin||0, gpmax = g.pmax||0;
      const L = pmin || gpmin, R = pmax || gpmax;
      if(!(gpmax>=L && gpmin<=R)) return false;
    }
    const age = parseInt(fltAge.value||"0",10)||0;
    if(age && g.age && g.age > age) return false; // require age <= selected
    const dmin = parseInt(fltDurMin.value||"0",10)||0;
    const dmax = parseInt(fltDurMax.value||"0",10)||0;
    if(dmin && g.dur < dmin) return false;
    if(dmax && g.dur > dmax) return false;
    const typesSel = Array.from(fltTypes.selectedOptions).map(o=>o.value);
    if(typesSel.length){
      const gs = new Set((g.types||[]));
      for(const t of typesSel){ if(!gs.has(t)) return false; }
    }
    return true;
  }

  function render(){
    // sort alpha by name
    const list = [...DATA.items].sort((a,b)=> a.name.localeCompare(b.name));
    const filtered = list.filter(matchesFilters);
    countInfo.textContent = filtered.length + " / " + list.length + " jeux";
    cards.innerHTML = filtered.map(g => `
      <article class="game">
        ${g.photo ? `<img src="${g.photo}" alt="">` : ""}
        <header>
          <strong>${escapeHtml(g.name)}</strong>
          <span class="badge">üë• ${g.pmin||"?"}-${g.pmax||"?"}</span>
          <span class="badge">üéÇ ${g.age||0}+</span>
          <span class="badge">‚è±Ô∏è ${g.dur||0} min</span>
          <span class="right tiny">${(g.types||[]).join(", ")}</span>
        </header>
        <div class="meta">
          ${g.notes ? `<span>üí° ${escapeHtml(g.notes)}</span>` : ""}
          ${g.url ? `<span>üîó <a href="${escapeAttr(g.url)}" target="_blank" rel="noopener">Lien</a></span>` : ""}
        </div>
        ${g.desc ? `<div class="desc">${escapeHtml(g.desc)}</div>` : ""}
      </article>
    `).join("");
    refreshSelect();
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // live filters
  [q, fltPlayersMin, fltPlayersMax, fltAge, fltDurMin, fltDurMax, fltTypes].forEach(el => {
    el.addEventListener("input", render);
    el.addEventListener("change", render);
  });

  // ---- Seed with user's list if empty ----
  if(!DATA.items || DATA.items.length===0){
    const seed = [
      { name:"Unanimo", pmin:3, pmax:8, age:7, dur:20, types:["Ambiance","Mots"], notes:"Connexion d‚Äôid√©es", url:"", desc:"Trouvez les mots auxquels penseront aussi les autres joueurs.", photo:"" },
      { name:"Time's Up! Family", pmin:4, pmax:12, age:8, dur:40, types:["Ambiance"], notes:"Version Family", url:"", desc:"Faites deviner des personnalit√©s en trois manches de plus en plus restrictives.", photo:"" },
      { name:"Rythme and Boulet", pmin:4, pmax:12, age:10, dur:20, types:["Ambiance"], notes:"Fun & rythm√©", url:"", desc:"Jeu d'ambiance o√π chaque joueur a un geste √† m√©moriser et encha√Æner.", photo:"" },
      { name:"Bataille navale (ES)", pmin:2, pmax:2, age:7, dur:20, types:["Classiques"], notes:"Version espagnole", url:"", desc:"Version espagnole de la bataille navale classique avec grilles et torpilles.", photo:"" },
      { name:"Saboteur", pmin:3, pmax:10, age:8, dur:30, types:["Bluff"], notes:"Trahison", url:"", desc:"Les nains cherchent l'or, mais certains sabotent le plan.", photo:"" },
      { name:"Qui est qui ?", pmin:2, pmax:2, age:6, dur:15, types:["D√©duction"], notes:"", url:"", desc:"", photo:"" },
      { name:"Skyjo", pmin:2, pmax:8, age:8, dur:30, types:["Cartes"], notes:"Tr√®s accessible", url:"", desc:"Faites le moins de points en r√©v√©lant strat√©giquement vos cartes.", photo:"" },
      { name:"Coloretto", pmin:2, pmax:5, age:8, dur:30, types:["Cartes"], notes:"", url:"", desc:"Jeu rapide de collections et choix tactiques.", photo:"" },
      { name:"Uno", pmin:2, pmax:10, age:6, dur:15, types:["Cartes"], notes:"Tr√®s populaire", url:"", desc:"D√©barrassez-vous de vos cartes avec des effets sp√©ciaux.", photo:"" },
      { name:"Flip", pmin:2, pmax:7, age:7, dur:15, types:["Cartes"], notes:"Stop ou encore", url:"", desc:"", photo:"" },
      { name:"Trio", pmin:3, pmax:6, age:7, dur:15, types:["Cartes"], notes:"Jeu rapide", url:"", desc:"Faites des trios de m√™me valeur ou s√©rie.", photo:"" },
      { name:"Jeu des sept familles", pmin:2, pmax:6, age:6, dur:20, types:["Cartes"], notes:"", url:"", desc:"", photo:"" },
      { name:"6 qui prend", pmin:2, pmax:10, age:10, dur:45, types:["Cartes"], notes:"", url:"", desc:"", photo:"" },
      { name:"Tarot", pmin:3, pmax:5, age:10, dur:60, types:["Classiques"], notes:"Cartes classiques", url:"", desc:"Jeu de plis avec atouts et appels.", photo:"" },
      { name:"Toy Battle", pmin:2, pmax:4, age:6, dur:30, types:["Combat","Enfants"], notes:"Peu connu", url:"", desc:"Combat strat√©gique entre jouets.", photo:"" },
      { name:"Monopoly", pmin:2, pmax:8, age:8, dur:180, types:["Commerce"], notes:"Classique", url:"", desc:"Achetez, vendez et g√©rez vos propri√©t√©s.", photo:"" },
      { name:"Exp√©ditions: Autour du Monde", pmin:2, pmax:6, age:10, dur:45, types:["Connaissances"], notes:"Voyage", url:"", desc:"Jeu de parcours autour du monde bas√© sur des questions.", photo:"" },
      { name:"Pand√©mie", pmin:2, pmax:4, age:8, dur:45, types:["Coop√©ratif"], notes:"", url:"", desc:"Enrayez des √©pid√©mies mondiales.", photo:"" },
      { name:"Qui l'a vu ?", pmin:2, pmax:4, age:6, dur:30, types:["Coop√©ratif","Enfants"], notes:"√âlectronique", url:"", desc:"Un voleur au ch√¢teau !", photo:"" },
      { name:"Dominion", pmin:2, pmax:4, age:13, dur:45, types:["Deckbuilding"], notes:"R√©f√©rence", url:"", desc:"Construisez votre deck pour un royaume efficace.", photo:"" },
      { name:"El Dorado", pmin:2, pmax:4, age:10, dur:60, types:["Deckbuilding","Course"], notes:"", url:"", desc:"Course dans la jungle vers la cit√© d'or.", photo:"" },
      { name:"The Lost Code", pmin:2, pmax:4, age:10, dur:30, types:["D√©duction"], notes:"Original", url:"", desc:"D√©duisez votre combinaison par indices crois√©s.", photo:"" },
      { name:"Las Vegas", pmin:2, pmax:5, age:8, dur:30, types:["D√©s","Prise de risque"], notes:"Fun", url:"", desc:"Gagnez de l'argent dans les casinos.", photo:"" },
      { name:"Splendor", pmin:2, pmax:4, age:10, dur:30, types:["D√©veloppement"], notes:"Facile √† apprendre", url:"", desc:"Collectez des gemmes pour des cartes de prestige.", photo:"" },
      { name:"Cluedo", pmin:2, pmax:6, age:8, dur:45, types:["Enqu√™te"], notes:"Classique", url:"", desc:"Trouvez meurtrier, arme et lieu.", photo:"" },
      { name:"Unlock!", pmin:1, pmax:6, age:10, dur:60, types:["Escape Game"], notes:"App requise", url:"", desc:"R√©solvez des √©nigmes √† temps.", photo:"" },
      { name:"Takenoko", pmin:2, pmax:4, age:8, dur:45, types:["Gestion","Objectifs"], notes:"Esth√©tique", url:"", desc:"Nourrissez le panda et cultivez la bambouseraie.", photo:"" },
      { name:"Scrabble", pmin:2, pmax:4, age:8, dur:60, types:["Lettres","Classiques"], notes:"", url:"", desc:"Formez des mots pour marquer des points.", photo:"" },
      { name:"Qwixx", pmin:2, pmax:5, age:7, dur:15, types:["D√©s"], notes:"", url:"", desc:"", photo:"" },
      { name:"Labyrinthe", pmin:2, pmax:4, age:7, dur:25, types:["Parcours"], notes:"Version lumineuse", url:"", desc:"Faites glisser les tuiles pour atteindre vos objectifs.", photo:"" },
      { name:"Skull King", pmin:2, pmax:8, age:10, dur:30, types:["Plis","Bluff"], notes:"", url:"", desc:"Jeu de plis avec annonces exactes et bluff.", photo:"" },
      { name:"Kingdomino", pmin:2, pmax:4, age:8, dur:20, types:["Pose de tuiles"], notes:"Tr√®s accessible", url:"", desc:"Construisez votre royaume en connectant des tuiles.", photo:"" },
      { name:"Kingdomino: √Çge des G√©ants", pmin:2, pmax:5, age:8, dur:20, types:["Pose de tuiles"], notes:"Extension", url:"", desc:"Ajoute des g√©ants et d√©fis.", photo:"" },
      { name:"Pop Quiz: La Bible", pmin:2, pmax:10, age:10, dur:30, types:["Quiz","Religieux"], notes:"", url:"", desc:"Questions bibliques ludiques.", photo:"" },
      { name:"Galerapagos", pmin:3, pmax:12, age:10, dur:30, types:["Semi-coop√©ratif"], notes:"Trahisons possibles", url:"", desc:"Survivez au naufrage‚Ä¶ ou pas.", photo:"" },
      { name:"Azul", pmin:2, pmax:4, age:8, dur:40, types:["Strat√©gie","Pose de tuiles"], notes:"", url:"", desc:"", photo:"" },
      { name:"Siam", pmin:2, pmax:2, age:9, dur:20, types:["Strat√©gie abstraite"], notes:"Jeu √† deux", url:"", desc:"Poussez les animaux adverses hors du plateau.", photo:"" },
      { name:"Dominos", pmin:2, pmax:4, age:5, dur:20, types:["Classiques"], notes:"", url:"", desc:"", photo:"" },
      { name:"Schotten Totten", pmin:2, pmax:2, age:10, dur:20, types:["Cartes","Strat√©gie"], notes:"", url:"", desc:"Affrontement tactique sur 9 bornes.", photo:"" }
    ];
    DATA.items = seed;
    ls.save(DATA);
  }

  refreshSelect();
  render();
  </script>
</body>
</html>
